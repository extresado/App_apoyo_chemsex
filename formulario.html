<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluación Chemsex - @BajadaSegura</title>
    
    <!-- Carga de Tailwind CSS (sigue siendo útil para el layout) -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fuente Montserrat (de index.html) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* * ==========================================
         * ESTILOS NEÓN ADAPTADOS (DE INDEX.HTML)
         * ==========================================
        */

        :root {
            --neon-pink: #FF00FF;
            --neon-red: #FF3300;
            --neon-blue: #00FFFF;
            --neon-green: #39FF14;
            --neon-purple: #9D00FF;
            --font-family: 'Montserrat', sans-serif;
        }

        body {
            background-color: #000000;
            color: #f0f0f0;
            font-family: var(--font-family);
            min-height: 100vh;
            padding-top: 5vh;
            padding-bottom: 5vh; /* Añadido para que haya scroll */
            box-sizing: border-box;
            position: relative;
        }

        /* Textura de ruido */
        body::after {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cfilter id='n' x='0' y='0'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='1' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23n)' opacity='1'/%3E%3C/svg%3E");
            opacity: 0.02;
            z-index: 100;
        }

        /* Contenedor principal (de index.html) */
        .main-container {
            width: 100%;
            max-width: 450px;
            margin: 0 auto;
            padding: 0 1.5rem;
            position: relative;
            z-index: 1;
        }
        
        /* Logo (de index.html) */
        .logo {
            width: 100px;
            height: 100px;
            margin: 0 auto;
            filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.9)) 
                    drop-shadow(0 0 16px rgba(255, 255, 255, 0.7));
        }

        /* Slogan (de index.html) */
        .slogan {
            font-weight: 300;
            font-size: 1.125rem;
            line-height: 1.6;
        }

        /* Botón Neón Base (de index.html) */
        .btn-neon {
            display: inline-block; /* Cambiado para botones de nav */
            width: 100%; /* Por defecto full-width */
            padding: 1.25rem;
            margin-bottom: 1rem; /* Reducido de 1.5rem */
            border: 2px solid var(--color-neon);
            color: var(--color-neon);
            background-color: rgba(10, 10, 10, 0.3);
            border-radius: 0.75rem;
            text-align: center;
            text-transform: uppercase;
            font-weight: 700;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(2px);
            box-shadow: 0 0 5px var(--color-neon), 0 0 10px var(--color-neon) inset;
        }

        .btn-neon:hover {
            background-color: var(--color-neon);
            color: #000000;
            box-shadow: 0 0 15px var(--color-neon), 0 0 30px var(--color-neon);
        }
        
        .btn-neon:disabled { /* Estilo para botones deshabilitados */
            --color-neon: #555;
            color: #555;
            border-color: #555;
            background-color: rgba(10, 10, 10, 0.1);
            cursor: not-allowed;
            box-shadow: none;
        }

        /* Colores de Botones */
        .btn-pink { --color-neon: var(--neon-pink); }
        .btn-red { --color-neon: var(--neon-red); }
        .btn-blue { --color-neon: var(--neon-blue); }
        .btn-purple { --color-neon: var(--neon-purple); }

        /* Animación Pulso (de index.html) */
        .btn-red {
            animation: pulse-red 2s infinite ease-in-out;
        }
        @keyframes pulse-red {
            0% { box-shadow: 0 0 5px var(--color-neon), 0 0 10px var(--color-neon) inset; }
            50% { box-shadow: 0 0 15px var(--color-neon), 0 0 25px var(--color-neon) inset, 0 0 25px var(--color-neon); }
            100% { box-shadow: 0 0 5px var(--color-neon), 0 0 10px var(--color-neon) inset; }
        }

        /* * ==========================================
         * NUEVOS ESTILOS (ESPECÍFICOS DEL FORMULARIO)
         * ==========================================
        */

        /* Texto de las preguntas */
        .question-number {
            font-size: 0.9rem;
            font-weight: 700;
            color: var(--neon-blue);
            text-transform: uppercase;
            margin-bottom: 0.5rem;
            text-align: center;
        }
        .question-text {
            font-size: 1.25rem; /* 20px */
            font-weight: 400;
            line-height: 1.6;
            margin-bottom: 1.5rem;
            text-align: center;
            color: #f0f0f0;
        }

        /* Opciones de Radio (NUEVO ESTILO NEÓN) */
        .radio-label-neon {
            display: block;
            width: 100%;
            padding: 1rem; /* Más pequeñas que botones de nav */
            margin-bottom: 0.75rem;
            border: 2px solid var(--color-neon);
            color: var(--color-neon);
            background-color: rgba(10, 10, 10, 0.3);
            border-radius: 0.75rem;
            text-align: center;
            font-weight: 700;
            transition: all 0.3s ease;
            cursor: pointer;
            backdrop-filter: blur(2px);
            box-shadow: 0 0 5px var(--color-neon), 0 0 10px var(--color-neon) inset;
            --color-neon: var(--neon-blue); /* Color por defecto (no seleccionada) */
        }

        input[type="radio"]:checked + .radio-label-neon {
            --color-neon: var(--neon-pink); /* Color seleccionada */
            background-color: var(--color-neon);
            color: #000000;
            box-shadow: 0 0 15px var(--color-neon), 0 0 30px var(--color-neon);
        }

        /* Inputs de Texto (Ubicación, Notas) */
        .form-label {
            color: var(--neon-blue);
            font-weight: 300;
            font-size: 1rem;
            line-height: 1.6;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        .form-input {
            background-color: rgba(10, 10, 10, 0.3);
            border: 2px solid var(--neon-blue);
            color: var(--neon-blue);
            border-radius: 0.75rem;
            padding: 0.75rem 1rem;
            width: 100%;
            margin-top: 0.5rem;
            transition: all 0.3s ease;
            box-shadow: 0 0 5px var(--neon-blue), 0 0 10px var(--neon-blue) inset;
            font-family: var(--font-family);
        }
        .form-input::placeholder {
            color: var(--neon-blue);
            opacity: 0.5;
        }
        .form-input:focus {
            outline: none;
            border-color: var(--neon-pink);
            color: var(--neon-pink);
            box-shadow: 0 0 10px var(--neon-pink), 0 0 15px var(--neon-pink) inset;
        }

        /* Estilos para el spinner */
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid var(--neon-pink); /* Color neón */
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Estilos para el texto de resultado (markdown) */
        .markdown-output {
            color: #f0f0f0;
            line-height: 1.7;
        }
        .markdown-output h1 { font-size: 1.75rem; font-weight: 800; margin-top: 1rem; margin-bottom: 0.5rem; color: var(--neon-pink);}
        .markdown-output h2 { font-size: 1.5rem; font-weight: 700; margin-top: 1rem; margin-bottom: 0.5rem; color: var(--neon-blue);}
        .markdown-output p { margin-bottom: 0.75rem; }
        .markdown-output a { color: var(--neon-green); text-decoration: underline; font-weight: 600; }
        .markdown-output ul { list-style-type: disc; margin-left: 1.5rem; padding-top: 0.5rem;}

    </style>
</head>
<body class="bg-black">

    <!-- Contenedor Principal (de index.html) -->
    <div class="main-container">

        <!-- Encabezado del Formulario (Estilo Neón) -->
        <header class="mb-8 text-center">
            <!-- Usamos la URL absoluta del logo que ya teníamos -->
            <img src="https://raw.githubusercontent.com/extresado/App_apoyo_chemsex/main/1000025194.png" alt="Logo BajadaSegura" class="logo">
            
            <h1 class="text-3xl font-bold text-center mt-6 mb-2" style="color: var(--neon-pink);">
                CHEMSEX
            </h1>
            <p class="slogan text-center text-gray-200">
                Una herramienta de orientación. Confidencial y Anónima.
            </p>
        </header>

        <!-- Contenedor principal de los pasos (sin .radical-card) -->
        <div id="quizContent">
            
            <!-- 1. Paso de Pregunta -->
            <div id="questionStep" class="hidden space-y-4">
                <!-- Estructura de pregunta simplificada -->
                <div>
                    <p id="questionNumber" class="question-number"></p>
                    <p id="questionText" class="question-text"></p>
                </div>

                <div id="optionsContainer" class="space-y-1">
                    <!-- Opciones de radio inyectadas aquí (JS modificado) -->
                </div>

                <!-- Botones de navegación (pequeños) -->
                <div class="flex justify-between pt-4">
                    <button id="prevButton" class="btn-neon btn-blue py-2 px-6 text-sm" style="width: auto;" disabled>
                        &larr; Anterior
                    </button>
                    <button id="nextButton" class="btn-neon btn-pink py-2 px-6 text-sm" style="width: auto;" disabled>
                        Siguiente &rarr;
                    </button>
                </div>
            </div>

            <!-- 2. Paso de Input Personalizado y Ubicación -->
            <div id="inputStep" class="hidden space-y-6">
                <div>
                    <p class="question-text mb-4">Información Adicional</p>

                    <!-- Input de Ubicación (MANDATORIO) -->
                    <div>
                        <label for="userLocation" class="form-label">¿En qué ciudad o región te encuentras? (Obligatorio)</label>
                        <input type="text" id="userLocation" required placeholder="Ej: Madrid, Barcelona..." class="form-input">
                    </div>

                    <!-- Notas Personalizadas (Opcional) -->
                    <div class="mt-4">
                        <label for="customNotes" class="form-label">¿Quieres añadir algo más?</label>
                        <p class="text-gray-400 text-xs mb-2 font-light">Cualquier contexto es valioso para evaluar en qué situación estás.</p>
                        <textarea id="customNotes" rows="4" class="form-input"></textarea>
                    </div>
                </div>
                
                <div class="flex justify-between pt-4">
                    <button id="inputPrevButton" class="btn-neon btn-blue py-2 px-6 text-sm" style="width: auto;">
                        &larr; Anterior
                    </button>
                    <button id="inputNextButton" class="btn-neon btn-pink py-2 px-6 text-sm" style="width: auto;">
                        Continuar
                    </button>
                </div>
            </div>


            <!-- 3. Paso Final de Acciones -->
            <div id="actionStep" class="hidden text-center space-y-4">
                <div>
                    <p class="question-text text-blue-400 mb-2">¡Cuestionario Completo!</p>
                    <p class="text-gray-300 font-light">Gracias por tu honestidad. Has dado un gran paso. ¿Qué camino eliges ahora?</p>
                    <p id="finalScoreText" class="text-lg font-bold mt-3" style="color: var(--neon-pink);"></p>
                </div>

                <!-- Botón de Emergencia (Destacado) -->
                <button id="emergencyButton" class="btn-neon btn-red w-full" onclick="handleEmergency()">
                    LLAMAR AL 112 (Emergencia)
                </button>

                <div class="flex flex-col space-y-4">
                    <button id="reflectionButton" class="btn-neon btn-pink w-full flex items-center justify-center">
                        <span id="reflectionButtonText">Reflexión + Recursos (LGTBIQ+)</span>
                        <div id="reflectionSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                    <button id="resourcesButton" class="btn-neon btn-purple w-full flex items-center justify-center">
                        <span id="resourcesButtonText">Solo Recursos (LGTBIQ+ Amigables)</span>
                        <div id="resourcesSpinner" class="spinner ml-3 hidden"></div>
                    </button>
                </div>
            </div>

            <!-- 4. Paso de Resultados -->
            <div id="resultStep" class="hidden">
                <!-- Contenedor de resultados (sin fondo) -->
                <div>
                    <h2 id="resultTitle" class="question-text text-blue-400 mb-4 text-center"></h2>
                    <div id="resultOutput" class="markdown-output min-h-[100px]">
                        <!-- Contenido de la IA o Search -->
                    </div>
                </div>
                
                <button id="emergencyButtonResults" class="btn-neon btn-red w-full mt-6" onclick="handleEmergency()">
                    LLAMAR AL 112 (Emergencia)
                </button>

                <button id="resetButton" class="btn-neon btn-blue w-full mt-4">
                    Reiniciar el Cuestionario
                </button>
            </div>

            <!-- Área de mensaje de error -->
            <div id="errorContainer" class="mt-6 p-4 border rounded-lg hidden text-sm" style="background-color: rgba(255, 51, 0, 0.1); border-color: var(--neon-red); color: var(--neon-red);">
                <p id="errorMessage"></p>
            </div>
        </div>
    </div>

    <script>
        // AVISO CRÍTICO DE SEGURIDAD (Sin cambios)
        const apiKey = "AIzaSyAdE1IgXbIuOq6mLTJGSxKUqPRJjB57I-M"; 
        
        const API_URL_BASE = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;
        const MAX_RETRIES = 5;
        const INITIAL_DELAY = 1000;
        const PARTNER_NAME = "@BajadaSegura";
        const EMERGENCY_NUMBER = "112";

        // Estado de la aplicación (Sin cambios)
        let currentStep = 0;
        const scores = Array(10).fill(null);
        let totalScore = 0;
        let customNotes = "";
        let userLocation = "";

        // Datos de preguntas (Sin cambios)
        const questionsData = [
            { text: "¿Con qué frecuencia consumes drogas específicamente para tener o prolongar encuentros sexuales?", name: "q1" },
            { text: "¿Has intentado reducir o controlar el uso de drogas para el sexo sin conseguirlo?", name: "q2" },
            { text: "¿Sientes una fuerte necesidad o compulsión (craving) de usar drogas antes o durante el sexo?", name: "q3" },
            { text: "¿El uso de drogas en este contexto ha causado problemas significativos en tu trabajo o relaciones personales?", name: "q4" },
            { text: "¿Has continuado con el chemsex a pesar de saber que está afectando negativamente tu salud (física o mental)?", name: "q5" },
            { text: "¿Necesitas aumentar la cantidad de droga para lograr el efecto deseado durante las sesiones de chemsex (tolerancia)?", name: "q6" },
            { text: "¿Has experimentado síntomas de malestar físico o emocional (abstinencia) cuando no has tenido chemsex por un tiempo?", name: "q7" },
            { text: "¿Dedicas mucho tiempo a planificar, conseguir, consumir o recuperarte de las sesiones de chemsex?", name: "q8" },
            { text: "¿Has abandonado o reducido actividades importantes (hobbies, socializar sin drogas) debido al chemsex?", name: "q9" },
            { text: "¿Has tenido sexo inseguro o tomado decisiones de riesgo bajo los efectos de las drogas, de las que luego te arrepientes?", name: "q10" },
        ];
        const options = [
            { label: "Nunca", value: 0 },
            { label: "Raramente", value: 1 },
            { label: "A veces", value: 2 },
            { label: "Frecuentemente", value: 3 },
            { label: "Casi siempre", value: 4 },
        ];

        // Referencias del DOM (Sin cambios en los IDs)
        const questionStep = document.getElementById('questionStep');
        const inputStep = document.getElementById('inputStep');
        const actionStep = document.getElementById('actionStep');
        const resultStep = document.getElementById('resultStep');
        const questionNumber = document.getElementById('questionNumber');
        const questionText = document.getElementById('questionText');
        const optionsContainer = document.getElementById('optionsContainer');
        const prevButton = document.getElementById('prevButton');
        const nextButton = document.getElementById('nextButton');
        const customNotesEl = document.getElementById('customNotes');
        const userLocationEl = document.getElementById('userLocation');
        const inputPrevButton = document.getElementById('inputPrevButton');
        const inputNextButton = document.getElementById('inputNextButton');
        const finalScoreText = document.getElementById('finalScoreText');
        const reflectionButton = document.getElementById('reflectionButton');
        const reflectionSpinner = document.getElementById('reflectionSpinner');
        const reflectionButtonText = document.getElementById('reflectionButtonText');
        const resourcesButton = document.getElementById('resourcesButton');
        const resourcesSpinner = document.getElementById('resourcesSpinner');
        const resourcesButtonText = document.getElementById('resourcesButtonText');
        const resultTitle = document.getElementById('resultTitle');
        const resultOutput = document.getElementById('resultOutput');
        const resetButton = document.getElementById('resetButton');
        const errorContainer = document.getElementById('errorContainer');
        const errorMessage = document.getElementById('errorMessage');

        // --- Navegación de la Aplicación ---

        function showStep(stepName) {
            questionStep.classList.add('hidden');
            inputStep.classList.add('hidden');
            actionStep.classList.add('hidden');
            resultStep.classList.add('hidden');
            hideError();

            if (stepName === 'question') {
                questionStep.classList.remove('hidden');
            } else if (stepName === 'input') {
                inputStep.classList.remove('hidden');
            } else if (stepName === 'action') {
                actionStep.classList.remove('hidden');
            } else if (stepName === 'result') {
                resultStep.classList.remove('hidden');
            }
        }

        function renderStep() {
            if (currentStep < questionsData.length) {
                // Paso de preguntas
                showStep('question');
                const q = questionsData[currentStep];
                questionNumber.textContent = `Pregunta ${currentStep + 1} de ${questionsData.length}`;
                questionText.textContent = q.text;

                // === MODIFICACIÓN CLAVE ===
                // Usamos la nueva clase CSS 'radio-label-neon'
                optionsContainer.innerHTML = options.map(option => `
                    <label class="flex items-center">
                        <input type="radio" name="${q.name}" value="${option.value}" class="hidden" 
                            ${scores[currentStep] !== null && parseInt(scores[currentStep]) === option.value ? 'checked' : ''}>
                        <span class="radio-label-neon">
                            ${option.label}
                        </span>
                    </label>
                `).join('');
                // === FIN DE MODIFICACIÓN ===

                prevButton.disabled = currentStep === 0;
                
                document.querySelectorAll(`input[name="${q.name}"]`).forEach(input => {
                    input.addEventListener('change', () => {
                        scores[currentStep] = input.value;
                        nextButton.disabled = false;
                        
                        // Opcional: auto-siguiente en móvil para fluidez
                        // setTimeout(() => nextStep(), 200);
                    });
                });
                
                nextButton.disabled = scores[currentStep] === null;

            } else if (currentStep === questionsData.length) {
                // Paso de input personalizado
                showStep('input');
                customNotesEl.value = customNotes;
                userLocationEl.value = userLocation;
            }
            else {
                // Paso de acciones
                totalScore = scores.reduce((sum, score) => sum + (parseInt(score) || 0), 0);
                finalScoreText.textContent = `Puntuación Total: ${totalScore} de 40 puntos.`;
                showStep('action');
            }
        }

        // Resto del JS (nextStep, inputStepNext, etc.) no necesita cambios
        // en su lógica, solo en los estilos que ya hemos aplicado.
        
        function nextStep() {
            if (currentStep < questionsData.length) {
                const checked = document.querySelector(`input[name="${questionsData[currentStep].name}"]:checked`);
                if (!checked) {
                    displayError("Por favor, selecciona una opción para continuar.");
                    return;
                }
                scores[currentStep] = checked.value;
                currentStep++;
                renderStep();
            }
        }

        function inputStepNext() {
            const location = userLocationEl.value.trim();
            if (location === "") {
                displayError("El campo de Ciudad/Región es obligatorio para buscar recursos.");
                return;
            }
            userLocation = location;
            customNotes = customNotesEl.value; 
            currentStep++;
            renderStep();
        }

        function inputStepPrev() {
            customNotes = customNotesEl.value;
            userLocation = userLocationEl.value.trim();
            currentStep--;
            renderStep();
        }


        function prevStep() {
            if (currentStep > 0) {
                currentStep--;
                renderStep();
            }
        }

        function resetQuiz() {
            currentStep = 0;
            scores.fill(null);
            totalScore = 0;
            customNotes = "";
            userLocation = "";
            resultOutput.innerHTML = '';
            reflectionButton.disabled = false;
            resourcesButton.disabled = false;
            reflectionButtonText.textContent = "Reflexión + Recursos (LGTBIQ+)";
            resourcesButtonText.textContent = "Solo Recursos (LGTBIQ+ Amigables)";
            showStep('question');
            renderStep();
        }
        
        function handleEmergency() {
            // Mensaje de emergencia adaptado al estilo neón
            resultOutput.innerHTML = `
                <div class="p-4 rounded-lg" style="border: 2px solid var(--neon-red); background-color: rgba(255, 51, 0, 0.1);">
                    <h2 class="text-white text-xl font-bold mb-2" style="color: var(--neon-red);">ATENCIÓN: LLAMADA DE EMERGENCIA</h2>
                    <p class="text-red-200">Si tú o alguien más está en peligro inmediato, es fundamental que marques el número de emergencia ahora.</p>
                    <p class="text-3xl font-black mt-3 text-yellow-300">TELÉFONO: ${EMERGENCY_NUMBER}</p>
                    <p class="text-red-300 mt-3 font-light">Por favor, marca el ${EMERGENCY_NUMBER} en tu teléfono. Mantén la calma.</p>
                </div>
            `;
            resultTitle.textContent = "Emergencia: Contacto Inmediato";
            showStep('result');
        }

        // --- Llamadas a la API y Lógica de Evaluación (Sin cambios) ---

        async function retryFetchWithBackoff(url, options, retries = MAX_RETRIES) {
            for (let i = 0; i < retries; i++) {
                try {
                    const response = await fetch(url, options);
                    if (response.status === 429 || response.status >= 500) {
                        if (i === retries - 1) throw new Error(`API failed after ${retries} attempts with status ${response.status}.`);
                        const delay = INITIAL_DELAY * (2 ** i) + Math.random() * 1000;
                        await new Promise(resolve => setTimeout(resolve, delay));
                        continue;
                    }
                    return response;
                } catch (error) {
                    if (i === retries - 1) throw error;
                    const delay = INITIAL_DELAY * (2 ** i) + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }

        async function handleReflection() {
            reflectionButton.disabled = true;
            resourcesButton.disabled = true;
            reflectionButtonText.textContent = "Analizando...";
            reflectionSpinner.classList.remove('hidden');
            resultTitle.textContent = "Reflexión Personalizada y Recursos";
            resultOutput.innerHTML = '<p class="text-center font-medium py-8" style="color: var(--neon-blue);">Conectando con un agente para la evaluación...</p>';
            
            showStep('result');

            const maxScore = questionsData.length * 4;
            let userPrompt = `Mi puntuación en el Cuestionario de Riesgo Chemsex es ${totalScore} de un máximo de ${maxScore} puntos. Por favor, interpreta este resultado.`;
            
            if (customNotes.trim() !== "") {
                userPrompt += ` Además, el usuario ha añadido las siguientes notas personales para que las consideres en la evaluación: "${customNotes.trim()}".`;
            }

            const systemPrompt = `Actúa como un amigo personal, empático y profesional que habla directamente con la persona que tomó el test. Tu tarea es proporcionar una evaluación objetiva y no diagnóstica del nivel de riesgo de Chemsex basándote en la puntuación y las notas. La evaluación debe ser clara, sensible y siempre debe terminar validando la emoción del usuario y ofreciendo un consejo de acción positivo y profesional.

            Usa el siguiente criterio de riesgo (NO lo muestres):
            - 0-10 puntos: Riesgo bajo.
            - 11-20 puntos: Riesgo moderado.
            - 21-30 puntos: Riesgo significativo.
            - 31-40 puntos: Riesgo alto/grave.

            La respuesta debe tener un tono de apoyo y confidencialidad. Una vez finalizada la reflexión, finaliza el texto con un título H2 (##) que diga "Recursos de Apoyo Localizados." para dar paso a la siguiente sección.`;

            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await retryFetchWithBackoff(API_URL_BASE, options);
                const result = await response.json();

                if (!response.ok) {
                    const errorDetail = result.error?.message || response.statusText;
                    throw new Error(`Error de la API: ${errorDetail}.`);
                }

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo generar la reflexión. Inténtalo de nuevo.";
                resultOutput.innerHTML = marked(text);

                await handleResourcesSearch(true);

            } catch (error) {
                console.error("Error en la evaluación de Gemini:", error);
                resultOutput.innerHTML = `<p style="color:var(--neon-red);" class="font-bold">Error en la Reflexión:</p><p>Lo siento, hubo un problema al contactar con la IA. Por favor, intenta la opción de Recursos Directos.</p>`;
                reflectionButton.disabled = false;
                resourcesButton.disabled = false;
                reflectionButtonText.textContent = "Reflexión + Recursos (LGTBIQ+)";
                reflectionSpinner.classList.add('hidden');
                resultOutput.innerHTML += '<p class="mt-4"><strong>Recursos Locales no disponibles por fallo.</strong></p>';
            }
        }

        async function handleResourcesSearch(isReflectionCombined = false) {
            
            if (!isReflectionCombined) {
                resourcesButton.disabled = true;
                reflectionButton.disabled = true;
                resourcesButtonText.textContent = "Buscando...";
                resourcesSpinner.classList.remove('hidden');
                resultTitle.textContent = "Recursos de Apoyo Localizados";
                resultOutput.innerHTML = '<p class="text-center font-medium py-8" style="color: var(--neon-blue);">Usando Google Search para encontrar ayuda profesional cerca de ti...</p>';
                showStep('result');
            } else {
                resultOutput.innerHTML += '<p class="text-center font-bold mt-6" style="color: var(--neon-green);">Buscando Recursos LGTBIQ+ Amigables...</p>';
                reflectionButtonText.textContent = "Buscando Recursos...";
            }

            const searchLocation = userLocation || "España";
            
            const userQuery = `Busca 3 a 5 centros de ayuda para adicciones, chemsex, y salud mental con enfoque o amigables con la comunidad LGTBIQ+ en ${searchLocation}. Si no encuentras recursos específicos LGTBIQ+, proporciona recursos generales de adicciones en esa área. Incluye el nombre, enlace web (si es posible) y un breve resumen.`;
            
            const systemPrompt = `Actúa como un asistente profesional. Tu objetivo es proporcionar una lista de recursos locales de ayuda profesional (centros de adicciones, salud mental, ONGs) con especial énfasis en servicios LGTBIQ+-amigables o específicos para Chemsex en la ubicación proporcionada. Si no encuentras recursos LGTBIQ+ en esa ciudad, proporciona los mejores centros generales de adicciones/salud mental en ${searchLocation}. Genera la lista con nombres, enlaces y una breve descripción. Es FUNDAMENTAL que los resultados sean enlaces reales a organizaciones.`;

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: { parts: [{ text: systemPrompt }] }
            };

            const options = {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            };

            try {
                const response = await retryFetchWithBackoff(API_URL_BASE, options);
                const result = await response.json();

                if (!response.ok) {
                    const errorDetail = result.error?.message || response.statusText;
                    throw new Error(`Error de la API: ${errorDetail}.`);
                }

                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "No se pudo encontrar recursos. Inténtalo de nuevo con una búsqueda más específica.";
                
                if (isReflectionCombined) {
                    resultOutput.innerHTML += marked(text);
                } else {
                    resultOutput.innerHTML = marked(text);
                }

            } catch (error) {
                console.error("Error en la búsqueda de recursos:", error);
                
                const errorHtml = `<p style="color:var(--neon-red);" class="font-bold">Error en la Búsqueda de Recursos:</p><p>Lo siento, hubo un problema al contactar con Google Search. No se pudieron encontrar recursos. Intenta reiniciar.</p>`;
                if (isReflectionCombined) {
                    resultOutput.innerHTML += errorHtml;
                } else {
                    resultOutput.innerHTML = errorHtml;
                }
            } finally {
                resourcesButton.disabled = false;
                reflectionButton.disabled = false;
                resourcesButtonText.textContent = "Solo Recursos (LGTBIQ+ Amigables)";
                reflectionButtonText.textContent = "Reflexión + Recursos (LGTBIQ+)";
                resourcesSpinner.classList.add('hidden');
                reflectionSpinner.classList.add('hidden');
            }
        }

        // --- Utilidades de Markdown y Error ---
        
        // Función 'marked' simplificada (sin cambios)
        function marked(markdown) {
            let html = markdown
                .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                .replace(/\*\*(.*?)\*\*/gim, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/gim, '<em>$1</em>')
                .replace(/^- (.*$)/gim, '<li>$1</li>')
                .replace(/\n\n/gim, '</p><p>')
                .replace(/(^<p>|<\/p>$)/g, ''); 
            html = html.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank">$1</a>');
            if (!html.startsWith('<h') && !html.stargitsWith('<li') && !html.startsWith('<a')) {
                html = `<p>${html}</p>`;
            }
            html = html.replace(/((?:<li>.*?<\/li>\s*)+)/gs, '<ul>$1</ul>');
            html = html.replace(/<\/p><ul>/g, '<ul>'); 
            html = html.replace(/<\/li><p>/g, '</li>'); 
            
            return html;
        }

        function displayError(message) {
            errorMessage.textContent = message;
            errorContainer.classList.remove('hidden');
        }

        function hideError() {
            errorContainer.classList.add('hidden');
        }

        // --- Event Listeners y Inicialización ---
        window.onload = () => {
            nextButton.addEventListener('click', nextStep);
            prevButton.addEventListener('click', prevStep);
            inputNextButton.addEventListener('click', inputStepNext);
            inputPrevButton.addEventListener('click', inputStepPrev);

            reflectionButton.addEventListener('click', handleReflection);
            resourcesButton.addEventListener('click', () => {
                handleResourcesSearch(false);
            });
            resetButton.addEventListener('click', resetQuiz);
            
            renderStep();
        };

    </script>
</body>
</html>

